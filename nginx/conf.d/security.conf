# VibeMusic 보안 설정
# 공통 보안 헤더 및 규칙

# Rate Limiting 존 정의 (확장)
limit_req_zone $binary_remote_addr zone=api_strict:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=api_normal:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api_burst:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=websocket_connect:10m rate=2r/s;
limit_req_zone $binary_remote_addr zone=websocket_data:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=static_files:10m rate=50r/s;
limit_req_zone $binary_remote_addr zone=general_web:10m rate=30r/s;

# Connection Limiting (동시 연결 수 제한)
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;

# DDoS 방어를 위한 연결 제한
limit_conn perip 20;
limit_conn perserver 1000;

# 보안 헤더 맵 정의
map $sent_http_content_type $security_headers {
    default "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' ws: wss:; media-src 'self' data: blob:; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';";
    ~^text/html "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' ws: wss:; media-src 'self' data: blob:; object-src 'none'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';";
    ~^application/json "default-src 'none';";
}

# 지리적 차단 (필요시 활성화)
# geo $blocked_country {
#     default 0;
#     include /etc/nginx/conf.d/blocked_countries.conf;
# }

# Bot 차단 설정
map $http_user_agent $bad_bot {
    default 0;
    ~*malicious 1;
    ~*bot 0;
    ~*crawler 0;
    ~*spider 0;
    ~*(wget|curl) 1;
    ~*scanner 1;
    ~*grabber 1;
    ~*harvester 1;
}

# 악성 요청 패턴 차단
map $request_uri $bad_request {
    default 0;
    ~*/\.env 1;
    ~*/wp-admin 1;
    ~*/wp-login 1;
    ~*\.php$ 1;
    ~*\.asp$ 1;
    ~*\.aspx$ 1;
    ~*/admin 1;
    ~*/phpmyadmin 1;
    ~*/xmlrpc 1;
    ~*eval\( 1;
    ~*base64_ 1;
    ~*union.*select 1;
}

# 허용된 HTTP 메소드만 허용
map $request_method $allowed_method {
    default 1;
    GET 0;
    POST 0;
    PUT 0;
    DELETE 0;
    PATCH 0;
    OPTIONS 0;
    HEAD 0;
}

# SSL 설정 (공통)
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
ssl_prefer_server_ciphers off;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 1d;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;